import { useContext } from "react";
import { useFieldArray, useWatch } from "react-hook-form";
import { useTranslation } from "react-i18next";
import { useEnhancedFormContext } from "hooks/useEnhancedFormContext";
import { Button, FormInput } from "components";
import { IEditedVaultDescription } from "types";
import VulnerabilitySeverityForm from "./VulnerabilitySeverityForm/VulnerabilitySeverityForm";
import { createNewVulnerabilitySeverity } from "@hats-finance/shared";
import { StyledVulnerabilitySeveritiesList } from "./styles";
import { VaultEditorFormContext } from "../../store";
import AddIcon from "@mui/icons-material/Add";

export function VulnerabilitySeveritiesList() {
  const { t } = useTranslation();
  const { control, register } = useEnhancedFormContext<IEditedVaultDescription>();
  const { fields: severities, append, remove } = useFieldArray({ control, name: "vulnerability-severities-spec.severities" });

  const isV1 = useWatch({ control, name: "version" }) === "v1";

  const { isEditingExitingVault } = useContext(VaultEditorFormContext);

  return (
    <StyledVulnerabilitySeveritiesList>
      <div className="helper-text" dangerouslySetInnerHTML={{ __html: t("vaultEditorSeveritiesExplanation") }} />

      <p className="helper">{t("setMaxBountyHelper")}:</p>
      <div className="maxBounty">
        <FormInput
          {...register(`parameters.maxBountyPercentage`)}
          disabled={isEditingExitingVault}
          type="whole-number"
          label={t("VaultEditor.vault-parameters.maxBountyPercentage")}
          placeholder={t("VaultEditor.vault-parameters.maxBountyPercentage-placeholder")}
          colorable
        />
      </div>

      {/* <div className="bountyCalculationExample">
        <div className="input">
          <p>Max severity reward (0%-100%)</p>
          <FormInput
            value={severityRewardExample}
            onChange={(e) => setSeverityRewardExample(+e.target.value)}
            type="whole-number"
            placeholder={t("VaultEditor.vault-parameters.maxBountyPercentage-placeholder")}
            colorable
            noMargin
            noErrorLabel
            min={0}
            max={100}
          />
        </div>
        <span className="operator">
          <TimesIcon />
        </span>
        <div className="input">
          <p>Max bounty of vault (10%-90%)</p>
          <FormInput
            {...register(`parameters.maxBountyPercentage`)}
            type="whole-number"
            placeholder={t("VaultEditor.vault-parameters.maxBountyPercentage-placeholder")}
            colorable
            noMargin
            noErrorLabel
            min={10}
            max={90}
          />
        </div>
        <span className="operator">
          <ArrowIcon />
        </span>
        <div className="input">
          <p>Will appear on dApp as</p>
          <FormInput
            value={viewOnDappExample}
            type="text"
            placeholder={t("VaultEditor.vault-parameters.maxBountyPercentage-placeholder")}
            colorable
            noMargin
            noErrorLabel
          />
        </div>
      </div> */}

      {isV1 && (
        <div>
          <FormInput
            {...register(`vulnerability-severities-spec.indexArray`)}
            label={t("VaultEditor.severities-index-array")}
            colorable
            placeholder={t("VaultEditor.severities-index-array-placeholder")}
          />
        </div>
      )}

      {severities.map((severity, index) => (
        <VulnerabilitySeverityForm key={severity.id} index={index} remove={remove} severitiesCount={severities.length} />
      ))}

      <Button styleType="invisible" onClick={() => append(createNewVulnerabilitySeverity(isV1 ? "v1" : "v2"))}>
        <AddIcon className="mr-1" />
        <span>{t("addSeverity")}</span>
      </Button>
    </StyledVulnerabilitySeveritiesList>
  );
}
